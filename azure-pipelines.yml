# Applies the terraform plan in this repository
trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
 - name: TerraformBackend.Location
   value: westeurope
 - name: TerraformBackend.ResourceGroup
   value: labNoSecInfraTF
 - name: TerraformBackend.StorageAccount
   value: labnosecinfratf
 - name: TerraformBackend.ContainerName
   value: nosecinfra
 - name: TerraformBackend.ServiceConnection
   value: LabNoSec


steps:
- task: Prisma Cloud IaC Scan@3
  displayName: Scan IaC templates with Prisma Cloud
  inputs:
    Path: '$(System.DefaultWorkingDirectory)'
    prismaCloudService: 'Prisma Cloud'
    # Report only, in this version we do not actually block any complicance failures
    High: '1'
    Medium: '2'
    Low: '5'
    Operator: 'or'
    IgnoreErrors: true
    Tags: 'env:prod'
- task: TerraformInstaller@0
  displayName: Install terraform
  inputs:
      terraformVersion: latest

- task: TerraformCLI@0
  displayName: 'terraform init'
  inputs:
    command: init
    backendType: azurerm
    backendServiceArm: $(TerraformBackend.ServiceConnection)
    # create backend storage account if doesn't exist
    ensureBackend: true
    backendAzureRmResourceGroupName: $(TerraformBackend.ResourceGroup)
    # azure location shortname of the backend resource group and storage account
    backendAzureRmResourceGroupLocation: $(TerraformBackend.Location)
    backendAzureRmStorageAccountName: $(TerraformBackend.StorageAccount)
    # azure storage account sku, used when creating the storage account
    backendAzureRmStorageAccountSku: 'Standard_LRS'
    # azure blob container to store the state file
    backendAzureRmContainerName: $(TerraformBackend.ContainerName)
    # azure blob file name
    backendAzureRmKey: terraform.tfstate

- task: TerraformCLI@0
  displayName: 'terraform plan'
  inputs:
    command: plan
    environmentServiceName: $(TerraformBackend.ServiceConnection)

- task: TerraformCLI@0
  displayName: 'terraform apply'
  inputs:
    command: apply
    environmentServiceName: $(TerraformBackend.ServiceConnection)
