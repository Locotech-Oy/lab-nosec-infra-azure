# Applies the terraform plan in this repository
trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
 - name: TerraformBackend.Location
   value: westeurope
 - name: TerraformBackend.ResourceGroup
   value: labNoSecInfra
 - name: TerraformBackend.StorageAccount
   value: labnosecinfratf
 - name: TerraformBackend.ContainerName
   value: nosecinfra

steps:
- task: TerraformInstaller@0
  displayName: Install terraform
  inputs:
      terraformVersion: latest

- task: TerraformCLI@0
  displayName: 'terraform init'
  inputs:
    command: init
    backendType: azurerm
    backendServiceArm: 'LabNoSec'
    # create backend storage account if doesn't exist
    ensureBackend: true
    backendAzureRmResourceGroupName: $(TerraformBackend.ResourceGroup)
    # azure location shortname of the backend resource group and storage account
    backendAzureRmResourceGroupLocation: $(TerraformBackend.Location)
    backendAzureRmStorageAccountName: $(TerraformBackend.StorageAccount)
    # azure storage account sku, used when creating the storage account
    backendAzureRmStorageAccountSku: 'Standard_LRS'
    # azure blob container to store the state file
    backendAzureRmContainerName: $(TerraformBackend.ContainerName)
    # azure blob file name
    backendAzureRmKey: infrax.tfstate

- task: TerraformCLI@0
  displayName: 'terraform plan'
  inputs:
    command: plan
    environmentServiceName: 'LabNoSec'